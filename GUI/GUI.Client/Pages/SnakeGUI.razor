@page "/snake"
@rendermode InteractiveServer
@using Blazor.Extensions
@using Blazor.Extensions.Canvas
@using Blazor.Extensions.Canvas.Canvas2D
@using System.Numerics
@using System.Diagnostics
@using System.Text.Json
@using GUI.Client.Controllers
@using GUI.Client.Models
@inject IJSRuntime JsRuntime;

<PageTitle>Snake</PageTitle>

<!-- Connection Inputs -->
<div id="ConnectionInputs">
    <div class="input-row">

        <label for="PlayerName">Player Name: </label>
        <input id="PlayerName" type="text" @bind="PlayerName" disabled="@network.IsConnected" />

        <label for="ServerNameOrAddress">Server Address: </label>
        <input id="ServerNameOrAddress" type="text" @bind="ServerNameOrAddress" disabled="@network.IsConnected" />

        <label for="ServerPort">Port: </label>
        <input id="ServerPort" type="number" @bind="ServerPort" disabled="@network.IsConnected" />

        @if (network.IsConnected)
        {
            <button class="btn btn-primary" @onclick="DisconnectFromServer">Disconnect</button>
        }
        else
        {
            <button class="btn btn-primary" @onclick="ConnectToServer">Connect</button>
        }

    </div>
</div>

<!-- Canvas for Game Display -->
<div id="snakeCanvas" style="position: fixed; width: 100%; height: 100%">
    <BECanvas Width="1000" Height="1000" @ref="canvasReference"></BECanvas>
</div>

@code
{

    // Connection and Player Info
    private string ServerNameOrAddress = "localhost";
    private int ServerPort = 11000;
    private string PlayerName { get; set; } = string.Empty;

    // Canvas and Network
    private BECanvasComponent canvasReference = null!;
    private Canvas2DContext context = null!;
    private IJSObjectReference jsModule = null!;
    private NetworkConnection network = new NetworkConnection();


    private NetworkController networkController = new NetworkController();

    private async Task ConnectToServer()
    {
        if (!network.IsConnected)
        {
            try
            {
                network.Connect(ServerNameOrAddress, ServerPort);
                network.Send(PlayerName);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to connect: {ex.Message}");
            }
        }
    }

    private void DisconnectFromServer()
    {
        if (network.IsConnected)
        {
            network.Disconnect();
            Console.WriteLine("Disconnected from server.");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./Pages/SnakeGUI.razor.js");
            context = await canvasReference.CreateCanvas2DAsync();
            await JsRuntime.InvokeAsync<object>("initRenderJS", DotNetObjectReference.Create(this));

            // TODO: Start the game loop

            // in the meantime, draw something to initialize the canvas
            // you may want to remove this after you are drawing something
            await context.SetFillStyleAsync("lightblue");
            await context.FillRectAsync(0, 0, 1000, 1000);
        }
    }

    //[JSInvokable]
    //public void HandleKeyPress(string key)
    //{
        //networkController.HandleUserInput(key);
    //}

}