@page "/snake"
@rendermode InteractiveServer
@using Blazor.Extensions
@using Blazor.Extensions.Canvas
@using Blazor.Extensions.Canvas.Canvas2D
@using System.Numerics
@using System.Diagnostics
@using System.Text.Json
@using GUI.Client.Models
@inject IJSRuntime JsRuntime;

<PageTitle>Snake</PageTitle>

<!-- ADDED -->
<img @ref="backgroundImage" id="bgImage" src="images/Background.png" alt="image" style="display:none;" />

<div id="snakeCanvas" style="position: fixed; width: 100%; height: 100%">
    <BECanvas Width="1000" Height="1000" @ref="canvasReference"></BECanvas>
</div>

@code
{

    // ADDED
    private const int WorldSize = 1000;

    // ADDED
    private World TheWorld = new(WorldSize);

    // ADDED (HARDCODED TO CHANGE)
    private const int ViewWidth = 1000;

    // ADDED (HARDCODED TO CHANGE)
    private const int ViewHeight = 1000;

    private BECanvasComponent canvasReference = null!;
    private Canvas2DContext context = null!;
    private IJSObjectReference jsModule = null!;

    // ADDED
    private ElementReference backgroundImage;

    /// <summary>
    ///     Called after the page is rendered. 
    ///     We use this to know when the first page load has occurred so we can initialize various data and start the server and drawing loops. 
    /// </summary>
    /// <param name="firstRender"></param>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./Pages/SnakeGUI.razor.js");
            context = await canvasReference.CreateCanvas2DAsync();
            await JsRuntime.InvokeAsync<object>("initRenderJS", DotNetObjectReference.Create(this));

            // Start the game loop
            GameLoop();

        }
    }

    /// <summary>
    ///     Renders the view once every 20 miliseconds (50 frames/second)
    /// </summary>
    private async void GameLoop()
    {
        while (true)
        {
            World snapshot = new World(TheWorld);

            await DrawFrame(snapshot);

            Thread.Sleep(20);
        }
    }

    /// <summary>
    ///     Draws one frame of the game.
    /// </summary>
    /// <param name="snapshot"></param>
    private async Task DrawFrame(World snapshot)
    {
        // Batch the drawing calls for better performance
        await context.BeginBatchAsync();

        // HARD CODED NEED TO FIX
        await context.DrawImageAsync(backgroundImage, 0, 0, ViewWidth, ViewHeight);

        // Finish batch drawing
        await context.EndBatchAsync();

        StateHasChanged();
    }
























    [JSInvokable]
    public void HandleKeyPress(string key)
    {
        // TODO: Once the client is connected and the handshake is complete,
        //       invoke some controller method to send the appropriate command to the server


        // TODO: Remove this, which is just here to show you what the 'key' string is for whatever key you pressed
        Debug.WriteLine("key pressed: " + key);
    }

}